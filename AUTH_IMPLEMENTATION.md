# Supabase è®¤è¯åŠŸèƒ½å®ç°è¯´æ˜

## ğŸ“‹ å®ç°å†…å®¹æ¦‚è¿°

æœ¬é¡¹ç›®å·²æˆåŠŸé›†æˆ Supabase è¿›è¡Œç”¨æˆ·è®¤è¯ï¼ŒåŒ…æ‹¬ä»¥ä¸‹åŠŸèƒ½ï¼š

### âœ… å·²å®ç°åŠŸèƒ½

1. **ç”¨æˆ·æ³¨å†Œ**
   - é‚®ç®±å¯†ç æ³¨å†Œ
   - ç”¨æˆ·åè®¾ç½®
   - æ³¨å†ŒæˆåŠŸæç¤º
   - è¡¨å•éªŒè¯

2. **ç”¨æˆ·ç™»å½•**
   - é‚®ç®±å¯†ç ç™»å½•
   - è‡ªåŠ¨è·³è½¬åˆ°é¦–é¡µ
   - é”™è¯¯æç¤º

3. **ç”¨æˆ·ç™»å‡º**
   - å®‰å…¨é€€å‡º
   - æ¸…é™¤ä¼šè¯
   - è·³è½¬åˆ°é¦–é¡µ

4. **è®¤è¯çŠ¶æ€ç®¡ç†**
   - å…¨å±€è®¤è¯ä¸Šä¸‹æ–‡
   - å®æ—¶çŠ¶æ€åŒæ­¥
   - è‡ªåŠ¨ä¼šè¯æ¢å¤

5. **è·¯ç”±ä¿æŠ¤**
   - å—ä¿æŠ¤è·¯ç”±ä¸­é—´ä»¶
   - æœªç™»å½•è‡ªåŠ¨é‡å®šå‘åˆ°ç™»å½•é¡µ
   - å·²ç™»å½•è®¿é—®ç™»å½•é¡µè‡ªåŠ¨è·³è½¬é¦–é¡µ

6. **UI é›†æˆ**
   - Header æ˜¾ç¤ºç™»å½•çŠ¶æ€
   - ç”¨æˆ·èœå•
   - ä¸ªäººä¿¡æ¯è·³è½¬

---

## ğŸ“ æ–‡ä»¶ç»“æ„

```
my-app/
â”œâ”€â”€ contexts/
â”‚   â””â”€â”€ AuthContext.tsx           # è®¤è¯ä¸Šä¸‹æ–‡å’Œ hooks
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ supabase/
â”‚       â”œâ”€â”€ client.ts             # å®¢æˆ·ç«¯ Supabase å®ä¾‹
â”‚       â””â”€â”€ server.ts             # æœåŠ¡ç«¯ Supabase å®ä¾‹
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ layout.tsx                # æ ¹å¸ƒå±€ï¼ˆåŒ…å« AuthProviderï¼‰
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â””â”€â”€ page.tsx              # ç™»å½•/æ³¨å†Œé¡µé¢
â”‚   â”œâ”€â”€ profile/
â”‚   â”‚   â””â”€â”€ page.tsx              # ä¸ªäººä¿¡æ¯é¡µï¼ˆå—ä¿æŠ¤ï¼‰
â”‚   â”œâ”€â”€ settings/
â”‚   â”‚   â””â”€â”€ page.tsx              # è®¾ç½®é¡µï¼ˆå—ä¿æŠ¤ï¼‰
â”‚   â””â”€â”€ history/
â”‚       â””â”€â”€ page.tsx              # å†å²è®°å½•é¡µï¼ˆå—ä¿æŠ¤ï¼‰
â”œâ”€â”€ components/
â”‚   â””â”€â”€ Header.tsx                # å¤´éƒ¨ç»„ä»¶ï¼ˆä½¿ç”¨ useAuthï¼‰
â”œâ”€â”€ middleware.ts                 # è·¯ç”±ä¿æŠ¤ä¸­é—´ä»¶
â”œâ”€â”€ types/
â”‚   â””â”€â”€ supabase.ts              # Supabase ç±»å‹å®šä¹‰
â”œâ”€â”€ .env                          # ç¯å¢ƒå˜é‡ï¼ˆä¸æäº¤åˆ° Gitï¼‰
â”œâ”€â”€ .env.example                  # ç¯å¢ƒå˜é‡æ¨¡æ¿
â””â”€â”€ SUPABASE_SETUP.md            # Supabase é…ç½®æŒ‡å—
```

---

## ğŸ”§ æ ¸å¿ƒå®ç°ç»†èŠ‚

### 1. AuthContext.tsx

æä¾›å…¨å±€è®¤è¯çŠ¶æ€å’Œæ–¹æ³•ï¼š

```typescript
// ä¸»è¦åŠŸèƒ½
- useAuth() hookï¼šè®¿é—®è®¤è¯çŠ¶æ€
- user: å½“å‰ç”¨æˆ·å¯¹è±¡
- session: å½“å‰ä¼šè¯
- loading: åŠ è½½çŠ¶æ€
- signUp(): æ³¨å†Œæ–¹æ³•
- signIn(): ç™»å½•æ–¹æ³•
- signOut(): ç™»å‡ºæ–¹æ³•
```

### 2. middleware.ts

ä¿æŠ¤éœ€è¦è®¤è¯çš„è·¯ç”±ï¼š

```typescript
// å—ä¿æŠ¤çš„è·¯ç”±
const protectedRoutes = ['/profile', '/settings', '/history'];

// è¡Œä¸º
- æœªç™»å½•è®¿é—®å—ä¿æŠ¤è·¯ç”± â†’ é‡å®šå‘åˆ° /auth
- å·²ç™»å½•è®¿é—® /auth â†’ é‡å®šå‘åˆ° /
```

### 3. Auth Page

ç™»å½•/æ³¨å†Œè¡¨å•ï¼š

```typescript
// åŠŸèƒ½
- ç™»å½•/æ³¨å†Œåˆ‡æ¢
- è¡¨å•éªŒè¯
- é”™è¯¯æç¤º
- æˆåŠŸæç¤º
- åŠ è½½çŠ¶æ€
- å¯†ç ç¡®è®¤
```

### 4. Header Component

æ˜¾ç¤ºè®¤è¯çŠ¶æ€ï¼š

```typescript
// åŠŸèƒ½
- æ˜¾ç¤ºç™»å½•/ç”¨æˆ·å¤´åƒ
- ç”¨æˆ·èœå•ï¼ˆä¸ªäººä¿¡æ¯ã€é€€å‡ºï¼‰
- ç‚¹å‡»å¤´åƒï¼š
  - æœªç™»å½• â†’ è·³è½¬ç™»å½•é¡µ
  - å·²ç™»å½• â†’ æ˜¾ç¤ºèœå•
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. é…ç½®ç¯å¢ƒå˜é‡

```bash
# å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿
cp .env.example .env

# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œå¡«å…¥ä½ çš„ Supabase å‡­è¯
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
```

### 2. å¯åŠ¨å¼€å‘æœåŠ¡å™¨

```bash
npm run dev
```

### 3. æµ‹è¯•è®¤è¯åŠŸèƒ½

1. è®¿é—® `http://localhost:3000/auth`
2. ç‚¹å‡»"æ³¨å†Œ"åˆ›å»ºæ–°è´¦æˆ·
3. å¡«å†™å§“åã€é‚®ç®±ã€å¯†ç 
4. æ³¨å†ŒæˆåŠŸåç™»å½•
5. æŸ¥çœ‹ Header æ˜¯å¦æ˜¾ç¤ºç”¨æˆ·å›¾æ ‡
6. ç‚¹å‡»ç”¨æˆ·å›¾æ ‡æµ‹è¯•èœå•åŠŸèƒ½

---

## ğŸ” å®‰å…¨ç‰¹æ€§

### Row Level Security (RLS)

Supabase è‡ªåŠ¨ä¸º `auth.users` è¡¨æä¾› RLS ä¿æŠ¤ã€‚

### è®¤è¯æµç¨‹å®‰å…¨

- âœ… å¯†ç åœ¨å®¢æˆ·ç«¯åŠ å¯†ä¼ è¾“
- âœ… Session å­˜å‚¨åœ¨å®‰å…¨çš„ HTTP-only cookies
- âœ… ä¸­é—´ä»¶éªŒè¯ç”¨æˆ·ä¼šè¯
- âœ… è·¯ç”±çº§åˆ«çš„è®¿é—®æ§åˆ¶

### æœ€ä½³å®è·µ

1. **ä¸è¦åœ¨å‰ç«¯æš´éœ² service_role key**
   - åªä½¿ç”¨ `anon` key
   - `service_role` key ä»…ç”¨äºæœåŠ¡å™¨ç«¯æ“ä½œ

2. **ä½¿ç”¨ RLS ä¿æŠ¤æ•°æ®**
   - ä¸ºæ‰€æœ‰è¡¨å¯ç”¨ RLS
   - åˆ›å»ºç»†ç²’åº¦çš„è®¿é—®ç­–ç•¥

3. **éªŒè¯ç”¨æˆ·è¾“å…¥**
   - å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯åŒé‡éªŒè¯
   - é˜²æ­¢ SQL æ³¨å…¥

---

## ğŸ“Š è®¤è¯æµç¨‹å›¾

### æ³¨å†Œæµç¨‹

```
ç”¨æˆ·å¡«å†™è¡¨å•
    â†“
ç‚¹å‡»"æ³¨å†Œ"
    â†“
è°ƒç”¨ signUp()
    â†“
Supabase åˆ›å»ºç”¨æˆ·
    â†“
å‘é€éªŒè¯é‚®ä»¶ï¼ˆå¦‚æœå¯ç”¨ï¼‰
    â†“
æ˜¾ç¤ºæˆåŠŸæç¤º
    â†“
3ç§’ååˆ‡æ¢åˆ°ç™»å½•æ¨¡å¼
```

### ç™»å½•æµç¨‹

```
ç”¨æˆ·å¡«å†™é‚®ç®±å¯†ç 
    â†“
ç‚¹å‡»"ç™»å½•"
    â†“
è°ƒç”¨ signIn()
    â†“
Supabase éªŒè¯å‡­è¯
    â†“
åˆ›å»ºä¼šè¯
    â†“
AuthContext æ›´æ–°çŠ¶æ€
    â†“
è·³è½¬åˆ°é¦–é¡µ
```

### è·¯ç”±ä¿æŠ¤æµç¨‹

```
ç”¨æˆ·è®¿é—® /profile
    â†“
middleware.ts æ‹¦æˆª
    â†“
æ£€æŸ¥ Supabase session
    â†“
æœ‰ä¼šè¯ï¼Ÿ
â”œâ”€ æ˜¯ â†’ å…è®¸è®¿é—®
â””â”€ å¦ â†’ é‡å®šå‘åˆ° /auth
```

---

## ğŸ¯ ä½¿ç”¨æ–¹æ³•

### åœ¨ç»„ä»¶ä¸­ä½¿ç”¨è®¤è¯

```tsx
import { useAuth } from '@/contexts/AuthContext';

export default function MyComponent() {
  const { user, loading, signOut } = useAuth();

  if (loading) {
    return <div>åŠ è½½ä¸­...</div>;
  }

  if (!user) {
    return <div>è¯·ç™»å½•</div>;
  }

  return (
    <div>
      <p>æ¬¢è¿ï¼Œ{user.email}</p>
      <button onClick={signOut}>é€€å‡º</button>
    </div>
  );
}
```

### åœ¨æœåŠ¡å™¨ç»„ä»¶ä¸­è·å–ç”¨æˆ·

```tsx
import { createClient } from '@/lib/supabase/server';

export default async function ServerComponent() {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    return <div>æœªç™»å½•</div>;
  }

  return <div>ä½ å¥½ï¼Œ{user.email}</div>;
}
```

---

## ğŸ› å¸¸è§é—®é¢˜

### 1. ç¯å¢ƒå˜é‡æœªåŠ è½½

**é—®é¢˜ï¼š** æç¤º "Invalid API key"

**è§£å†³ï¼š**
```bash
# ç¡®ä¿ .env æ–‡ä»¶å­˜åœ¨ä¸”æ ¼å¼æ­£ç¡®
# é‡å¯å¼€å‘æœåŠ¡å™¨
npm run dev
```

### 2. ç™»å½•åç«‹å³é€€å‡º

**é—®é¢˜ï¼š** ç™»å½•æˆåŠŸä½†ç«‹åˆ»é€€å‡º

**è§£å†³ï¼š**
- æ£€æŸ¥ middleware.ts é…ç½®
- ç¡®è®¤ cookies è®¾ç½®æ­£ç¡®
- æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯

### 3. æ”¶ä¸åˆ°éªŒè¯é‚®ä»¶

**é—®é¢˜ï¼š** æ³¨å†Œåæ²¡æœ‰æ”¶åˆ°é‚®ä»¶

**è§£å†³ï¼š**
- å¼€å‘ç¯å¢ƒå¯ä»¥ä¸´æ—¶å…³é—­é‚®ç®±éªŒè¯
- åœ¨ Supabase åå°çš„ Authentication â†’ Providers â†’ Email ä¸­å…³é—­ "Confirm email"

---

## ğŸ”„ åç»­ä¼˜åŒ–å»ºè®®

1. **æ·»åŠ å¯†ç é‡ç½®åŠŸèƒ½**
   ```tsx
   const resetPassword = async (email: string) => {
     await supabase.auth.resetPasswordForEmail(email);
   };
   ```

2. **æ·»åŠ é‚®ç®±å˜æ›´åŠŸèƒ½**
   ```tsx
   const updateEmail = async (newEmail: string) => {
     await supabase.auth.updateUser({ email: newEmail });
   };
   ```

3. **æ·»åŠ ç”¨æˆ·èµ„æ–™æ›´æ–°**
   ```tsx
   const updateProfile = async (data: { name: string }) => {
     await supabase.auth.updateUser({
       data: { name: data.name }
     });
   };
   ```

4. **é›†æˆç¤¾äº¤ç™»å½•ï¼ˆå¦‚éœ€è¦ï¼‰**
   - Google OAuth
   - GitHub OAuth
   - å…¶ä»–æä¾›å•†

5. **å®ç°"è®°ä½æˆ‘"åŠŸèƒ½**
   ```tsx
   // åœ¨ signIn æ—¶è®¾ç½®æ›´é•¿çš„ä¼šè¯
   await supabase.auth.signInWithPassword({
     email,
     password,
   }, {
     options: {
       persistSession: true
     }
   });
   ```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Supabase é…ç½®æŒ‡å—](./SUPABASE_SETUP.md)
- [Supabase Auth å®˜æ–¹æ–‡æ¡£](https://supabase.com/docs/guides/auth)
- [Next.js SSR é›†æˆ](https://supabase.com/docs/guides/auth/server-side/nextjs)

---

## âœ¨ æ€»ç»“

ç°åœ¨ä½ çš„é¡¹ç›®å·²ç»å…·å¤‡å®Œæ•´çš„ç”¨æˆ·è®¤è¯åŠŸèƒ½ï¼š

âœ… ç”¨æˆ·æ³¨å†Œå’Œç™»å½•
âœ… ä¼šè¯ç®¡ç†
âœ… è·¯ç”±ä¿æŠ¤
âœ… è®¤è¯çŠ¶æ€ç®¡ç†
âœ… å®‰å…¨æ€§ä¿éšœ
âœ… è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒ

å¯ä»¥å¼€å§‹ä½¿ç”¨äº†ï¼ğŸš€
